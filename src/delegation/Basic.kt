package delegation

import kotlin.reflect.KProperty

/**
 * Covers basics of property delegation & possible use case.
 *
 * @Author cjeon
 * @Since 28/11/2017
 */
class SomeClass(val single: Int) {
    val doubled: Int by DoubleDelegate()
}

class DoubleDelegate {
    /* Returns ğŸ‘‡ value instead of original value */
    operator fun getValue(thisRef: SomeClass, property: KProperty<*>): Int {
        println("DoubleDelegate: getValue called!")
        return thisRef.single * 2
    }

    // single ì„ ë°”ë¡œ delegate ë¡œ ì„¤ì •í•˜ê³  í•­ìƒ ì„¤ì •í•˜ëŠ” ê°’ê³¼ ë³´ì´ëŠ” ê°’ì„ ë‹¤ë¥´ê²Œ í•  ìˆ˜ë„ ìˆì§€ë§Œ
    // Context ë¥¼ ëª¨ë¥´ë©´ ì´í•´í•˜ê¸° ì‰½ì§€ ì•Šì•„ì„œ ex: 1ë¡œ ì„¤ì •í–ˆëŠ”ë° ì½ì„ ë• í•­ìƒ 2ê°€ ë‚˜ì˜´.
    // íŠ¹ìˆ˜í•œ ê²½ìš° - ex: ìë£Œí˜•ì´ ì™„ì „íˆ ë‹¤ë¦„ - ìˆ«ìë¥¼ ë„£ìœ¼ë©´ Matrix ê°€ ë‚˜ì˜¨ë‹¤ ë“± í˜¹ì€
    // Project member ê°€ ëª¨ë‘ property delegation ì— ìµìˆ™í•´ì§€ë©´ ì‚¬ìš©í•  ìˆ˜ ìˆì„ë“¯.
}

fun main(args : Array<String>){
    /* Use case of getter delegation */
    val classWithDelegate = SomeClass(1)
    println(classWithDelegate.doubled)

    println("- - - - - - - - - - - -")

    /* Use case of setter delegation */
    val complexState = ComplexState()
    println(complexState.state)
    complexState.state = ComplexState.State.STARTED
    stateSetter(complexState, ComplexState.State.RESUMED)
    Nom().nomStateSetter(complexState, ComplexState.State.DESTROYED)
}

class ComplexState {
    enum class State { CREATED, STARTED, RESUMED, PAUSED, STOPPED, DESTROYED}
    var state : State by StateLogger()

    class StateLogger {
        /* getValue ë§Œ ì§€ì •í•˜ëŠ” ê±´ ê°€ëŠ¥í•˜ì§€ë§Œ setValue ë§Œ ì§€ì •í•˜ëŠ” ê±´ ë¶ˆê°€ëŠ¥í•¨. (ì™¤ê¹Œìš” ? ì €ë„ ëª¨ë¦…ë‹ˆë‹¤) */
        /* ì—¬ê¸°ì„œëŠ” íˆ¬ëª…í•˜ê²Œ ê°’ì„ ì „í•´ì£¼ê¸°ìœ„í•´ duplicate ë¥¼ ê°€ì§€ê³  ìˆìŒ. */
        /* (ê·¸ëƒ¥ thisRef.state ë¥¼ í•˜ë©´ getValue ê°€ ë‹¤ì‹œ ë¶ˆë ¤ì„œ ë¬´í•œ ë£¨í”„ë¥¼ íƒ.) */
        /* (duplicate ì—†ì´ íˆ¬ëª…í•œ getValue êµ¬í˜„í•˜ì‹  ë¶„ì€ ì—°ë½ë°”ëë‹ˆë‹¤ â˜ï¸) */
        var state : ComplexState.State = ComplexState.State.CREATED
        operator fun getValue(thisRef: ComplexState, property: KProperty<*>): ComplexState.State {
            return state
        }

        operator fun setValue(thisRef: ComplexState, property: KProperty<*>, value: ComplexState.State) {
            state = value
            val stackTrace = Thread.currentThread().stackTrace
            // 0 = getStackTrace() - ğŸ‘†
            // 1 = setValue() - this method
            // 2 = setState() - invisible method generated by kotlin
            // 3 = caller of setState() - what we want to know
            println(stackTrace[3].methodName)
        }
    }
}

fun stateSetter(complexState: ComplexState, state : ComplexState.State) {
    complexState.state = state
}

class Nom {
    fun nomStateSetter(complexState: ComplexState, state : ComplexState.State) {
        complexState.state = state
    }
}

/* Additional Info - simple delegation */
class SimpleDelegation() {
    var number = 3
        set(value) = println("setting value of number to $value")
}